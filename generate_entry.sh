#!/bin/zsh
# ============================================================================
# 日記エントリ生成スクリプト
# ============================================================================
# このスクリプトは、最新の日記ファイルの次の日付のエントリを生成するための
# 各種変数を準備します。
# 
# 動作概要:
#   1. 最新の日記ファイル（????-??-??.md形式）を検索
#   2. そのファイルの日付の「次の日」を計算
#   3. その日付を元に、年、月、ディレクトリパス、前後の日付などを計算
#   4. 日本語形式のタイトル日付を生成
# ============================================================================

# ----------------------------------------------------------------------------
# 初期日付の設定（後で上書きされる可能性あり）
# ----------------------------------------------------------------------------
# ${1:-$(date "+%Y-%m-%d")} の意味:
#   - $1: スクリプトの第一引数（指定された日付）
#   - :- : パラメータ展開のデフォルト値指定演算子
#   - $(date "+%Y-%m-%d"): 引数がなければ今日の日付を取得
# 
# 例: ./generate_entry.sh 2025-04-15 → TODAY="2025-04-15"
#      ./generate_entry.sh            → TODAY="2026-01-03"（今日の日付）
# ----------------------------------------------------------------------------
TODAY=${1:-$(date "+%Y-%m-%d")}

# ----------------------------------------------------------------------------
# 最新の日記ファイルを検索
# ----------------------------------------------------------------------------
# find . -type f -name "????-??-??.md":
#   - . : カレントディレクトリから再帰的に検索
#   - -type f : ファイルのみ（ディレクトリは除外）
#   - -name "????-??-??.md": 日付形式のファイル名にマッチ
#     ? は任意の1文字（例: 2025-04-12.md, 2026-01-01.md）
# 
# | sort | tail -1:
#   - sort: ファイル名を辞書順（日付順）にソート
#   - tail -1: 最後の1行（最新の日付のファイル）を取得
# 
# 結果例: ./2026/01/2026-01-02.md
# ----------------------------------------------------------------------------
LATEST_FILE=$(find . -type f -name "????-??-??.md" | sort | tail -1)
echo "LATEST_FILE = \"$LATEST_FILE\""

# ----------------------------------------------------------------------------
# 最新ファイルの日付部分を抽出
# ----------------------------------------------------------------------------
# basename "$LATEST_FILE" .md の意味:
#   - basename: パスからファイル名部分だけを抽出
#   - "$LATEST_FILE": 例: ./2026/01/2026-01-02.md
#   - .md: 拡張子を除去
# 
# 結果例: 2026-01-02
# ----------------------------------------------------------------------------
LATEST_DATE=$(basename "$LATEST_FILE" .md)

# ----------------------------------------------------------------------------
# 最新ファイルの「次の日」をTODAYに設定（上書き）
# ----------------------------------------------------------------------------
# date -j -v+1d -f "%Y-%m-%d" "$LATEST_DATE" "+%Y-%m-%d" の意味:
#   - -j: macOSのdateコマンドで、日付文字列を解析するオプション
#   - -v+1d: 日付に1日を加算（+1d = plus 1 day）
#   - -f "%Y-%m-%d": 入力日付の形式を指定（例: 2026-01-02）
#   - "$LATEST_DATE": 解析する日付文字列
#   - "+%Y-%m-%d": 出力形式を指定（YYYY-MM-DD形式）
# 
# 例: LATEST_DATE="2026-01-02" → TODAY="2026-01-03"
# 
# 注意: この時点で、最初に設定したTODAYの値は上書きされます
# ----------------------------------------------------------------------------
TODAY=$(date -j -v+1d -f "%Y-%m-%d" "$LATEST_DATE" "+%Y-%m-%d")

# ============================================================================
# TODAYの値を元に、各種変数を計算
# ============================================================================
# 以下、macOSのdateコマンド（-jオプション）を使用して日付を操作します。
# Linuxのdateコマンドとは構文が異なるため注意が必要です。
# ============================================================================

# ----------------------------------------------------------------------------
# 年（YEAR）を抽出
# ----------------------------------------------------------------------------
# date -j -f "%Y-%m-%d" "$TODAY" "+%Y":
#   - -f "%Y-%m-%d": 入力形式（YYYY-MM-DD）
#   - "$TODAY": 解析する日付（例: 2026-01-03）
#   - "+%Y": 出力形式（年のみ、4桁）
# 
# 結果例: 2026
# ----------------------------------------------------------------------------
YEAR=$(date -j -f "%Y-%m-%d" "$TODAY" "+%Y")

# ----------------------------------------------------------------------------
# 月（MONTH）を抽出
# ----------------------------------------------------------------------------
# "+%m": 月を2桁の数字で出力（01-12）
# 
# 結果例: 01
# ----------------------------------------------------------------------------
MONTH=$(date -j -f "%Y-%m-%d" "$TODAY" "+%m")

# ----------------------------------------------------------------------------
# ターゲットディレクトリパスを生成
# ----------------------------------------------------------------------------
# 日記ファイルを保存するディレクトリパス
# 
# 結果例: 2026/01
# ----------------------------------------------------------------------------
TARGET_DIR="$YEAR/$MONTH"

# ----------------------------------------------------------------------------
# 昨日のファイルパスを生成
# ----------------------------------------------------------------------------
# date -j -v-1d: 日付から1日を減算（-1d = minus 1 day）
# "+%Y/%m/%Y-%m-%d.md": 出力形式（例: 2026/01/2026-01-02.md）
# 
# 結果例: 2026/01/2026-01-02.md
# ----------------------------------------------------------------------------
YESTERDAY_STR=$(date -j -v-1d -f "%Y-%m-%d" "$TODAY" "+%Y/%m/%Y-%m-%d.md")

# ----------------------------------------------------------------------------
# 明日のファイルパスを生成
# ----------------------------------------------------------------------------
# date -j -v+1d: 日付に1日を加算
# 
# 結果例: 2026/01/2026-01-04.md
# ----------------------------------------------------------------------------
TOMORROW_STR=$(date -j -v+1d -f "%Y-%m-%d" "$TODAY" "+%Y/%m/%Y-%m-%d.md")

# ----------------------------------------------------------------------------
# 日本語形式のタイトル日付を生成
# ----------------------------------------------------------------------------
# LC_ALL=ja_JP.UTF-8: ロケールを日本語に設定（曜日を日本語で表示するため）
# "+%Y年%m月%d日（%a）": 出力形式
#   - %Y: 年（4桁）
#   - %m: 月（2桁）
#   - %d: 日（2桁）
#   - %a: 曜日の短縮形（日本語ロケールで「月」「火」など）
# 
# 結果例: 2026年01月03日（金）
# ----------------------------------------------------------------------------
TITLE_DATE=$(LC_ALL=ja_JP.UTF-8 date -j -f "%Y-%m-%d" "$TODAY" "+%Y年%m月%d日（%a）")

# ============================================================================
# デバッグ用: 計算された変数の内容を表示
# ============================================================================
# スクリプトの動作確認やトラブルシューティングのために、
# すべての変数の値を出力します。
# ============================================================================
echo "TODAY = \"$TODAY\" (指定された日付)"
echo "TITLE_DATE = \"$TITLE_DATE\""
echo "YEAR = \"$YEAR\""
echo "MONTH = \"$MONTH\""
echo "TARGET_DIR = \"$TARGET_DIR\""
echo "YESTERDAY_STR = \"$YESTERDAY_STR\""
echo "TOMORROW_STR = \"$TOMORROW_STR\""
